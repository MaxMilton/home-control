<!--

  FIXME: Brightness should change instantly

  FIXME: Random timeouts -- could it be something to do with using Promise?

  TODO: Add way to edit device name, host, port, etc.

  TODO: Add nice colour picker

  TODO: Add scheduled events

  TODO: Nice brightness slider input

  TODO: Add some preset modes (flow colours, sunrise, sunset) + allow scheduling them

-->

<svelte:head>
  <title>{name} | Home Control</title>
</svelte:head>

<h1>{name}</h1>

<div class="muted">{host}:{port}</div>

<div class="form-group">
  <MinnaSwitch bind:value="on" on:change="toggle()" />
</div>

<div class="form-group">
  <button class="button red3" type="button" on:click="setColor('ff0000')">RED</button>
  <button class="button green3" type="button" on:click="setColor('00ff00')">GREEN</button>
  <button class="button blue3" type="button" on:click="setColor('0000ff')">BLUE</button>
  <button class="button" type="button" on:click="setColor('ffffff')">WHITE</button>
</div>

<div class="form-group mt4">
  <datalist id="tickmarks">
    <option value="1" label="1%">
    <option value="10">
    <option value="20">
    <option value="30">
    <option value="40">
    <option value="50" label="50%">
    <option value="60">
    <option value="70">
    <option value="80">
    <option value="90">
    <option value="100" label="100%">
  </datalist>

  <label class="label" for="brightness">Brightness</label>
  <input bind:value="brightness" class="range" type="range" list="tickmarks" on:change="setBrightness()">
  <MinnaInputNumber bind:value="brightness" id="brightness" on:change="setBrightness()" />
</div>

<div class="form-group mt4">
  <label class="label" for="color">Color</label>
  <input bind:value="color" class="color" type="color" id="color" on:change="setColor()">
  {color}
</div>

<button
  class="button button-clear float-right red3"
  type="button"
  on:click="$deviceDelete(params.id)"
>
  Delete Device
</button>

<script>
  import MinnaSwitch from '@minna-ui/switch';
  import MinnaInputNumber from '../../components/MinnaInputNumber.html';

  export default {
    components: {
      MinnaSwitch,
      MinnaInputNumber,
    },
    methods: {
      async toggle() {
        const { id } = this.get().params;
        const res = await fetch(`/api/command/${id}?action=toggle`);
        if (!res.ok) throw new Error(res.statusText);
      },

      async setBrightness() {
        const { params: { id }, brightness } = this.get();
        const res = await fetch(`/api/command/${id}?action=brightness&value=${brightness}`);
        if (!res.ok) throw new Error(res.statusText);
      },

      async setColor(value) {
        const { params: { id }, color } = this.get();
        let hex = value || color;
        hex = hex[0] === '#' ? hex.slice(1) : hex;

        const res = await fetch(`/api/command/${id}?action=color&value=${hex}`);

        if (!res.ok) throw new Error(res.statusText);
      },
    },

    async preload({ params, query }) {
      const res = await this.fetch(`/api/device/info/${params.id}`);

      if (!res.ok) throw new Error(res.statusText);

      return res.json();
    }
  };
</script>

<style type="text/postcss">
  .range {
    width: 16rem;
  }

  .color {
    width: 8rem;
  }
</style>
