<!-- @format -->

<!--
  TODO: Add way to edit device name, host, port, etc.

  TODO: Ability to remove colour presets

  TODO: Add nice colour picker

  TODO: Add scheduled events

  TODO: Nice brightness slider input

  TODO: Preset flows (flow colours, sunrise, sunset) + allow scheduling them
-->

<script context="module">
  // eslint-disable-next-line consistent-return
  export async function preload({ params }) {
    const res = await this.fetch(`/api/device/info/${params.id}`);

    if (res.ok) {
      const data = await res.json();
      return data;
    }

    this.error(res.status, res.statusText);
  }
</script>

<script>
  // import { Switch } from 'minna-ui';
  import Switch from '@minna-ui/switch/src/Switch.svelte';
  import { onMount } from 'svelte';
  import * as sapper from '@sapper/app'; // eslint-disable-line
  import { colors, deviceDelete, presetColorGet, presetColorPut } from '../../store';

  export let params;
  export let id;
  export let on;
  export let brightness;
  export let name;
  export let host;
  export let port;
  export let color;

  console.log('!!! HMM', params, id, brightness);

  let colorName = '';

  onMount(() => {
    // get colour presets
    presetColorGet();
  });

  async function toggle() {
    const res = await fetch(`/api/command/${id}?action=toggle`);

    if (!res.ok) throw new Error(res.statusText);
  }

  async function setBrightness() {
    const res = await fetch(`/api/command/${id}?action=brightness&value=${brightness}`);

    if (!res.ok) throw new Error(res.statusText);
  }

  async function setColor(value) {
    let hex = value || color;
    hex = hex[0] === '#' ? hex.slice(1) : hex;

    // update UI with new colour
    if (value) color = value;

    const res = await fetch(`/api/command/${id}?action=color&value=${hex}`);

    if (!res.ok) throw new Error(res.statusText);
  }

  function savePresetColor() {
    try {
      presetColorPut(null, { color, name: colorName || color });
    } catch (err) {
      // TODO: Handle error better
      console.error(err);
    }
  }

  async function deviceRemove(id) {
    try {
      await deviceDelete(id);
      sapper.goto('/');
    } catch (err) {
      // TODO: Handle error better
      console.error(err);
    }
  }
</script>

<svelte:head>
  <title>{name} | Homie Bot</title>
</svelte:head>

<h1 class="mb1">{name}</h1>

<div class="code">{host}:{port}</div>

<div class="form-group mt4">
  <Switch bind:value="{on}" on:change="{toggle}" />
</div>

<div class="form-group">
  <label class="label">Presets</label>
  {#each $colors as color}
    <button
      class="button button-color ttu"
      style="border-color:{color.data.color};"
      type="button"
      on:click="{() => setColor(color.data.color)}"
    >
      {color.data.name}
    </button>
  {:else}
    <p>No color presets found.</p>
  {/each}
</div>

<div class="form-group mt4">
  <label class="label" for="color">Color <span class="muted">({color})</span></label>
  <input bind:value="{color}" class="input color pa0" type="color" id="color" on:change="{setColor}">
  <input bind:value="{colorName}" class="input input-mini" type="text" placeholder="{color}">
  <button class="button" type="button" on:click="{savePresetColor}">Save</button>
</div>

<div class="form-group mt4">
  <datalist id="tickmarks">
    <option value="1" label="1%">
    <option value="10">
    <option value="20">
    <option value="30">
    <option value="40">
    <option value="50" label="50%">
    <option value="60">
    <option value="70">
    <option value="80">
    <option value="90">
    <option value="100" label="100%">
  </datalist>

  <label class="label" for="brightness">Brightness <span class="muted">({brightness}%)</span></label>
  <input bind:value="{brightness}" class="range" type="range" list="tickmarks" on:change="{setBrightness}">
</div>

<button
  class="button button-clear red3"
  type="button"
  on:click="{() => deviceRemove(params.id)}"
>
  Delete Device
</button>

<style type="text/postcss">
  @import 'import.css';

  .button-color {
    padding-left: calc($button-padding-x - 0.25em);
    border-left: 1em solid;
  }

  .color {
    width: 7em;
    height: 2.25em;
    vertical-align: top;
  }

  .input-mini {
    max-width: 10em;
  }

  .range {
    width: 100%;
  }
</style>
