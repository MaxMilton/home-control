<svelte:head>
  <title>{name} | Home Control</title>
</svelte:head>

<div class="form-group">
  <button class="button" type="button" on:click="toggle()">TOGGLE</button>
  <button class="button" type="button" on:click="getDeviceInfo()">DEVICE INFO</button>
</div>
<div class="form-group">
  <button class="button red3" type="button" on:click="setColor(0)">RED</button>
  <button class="button green3" type="button" on:click="setColor(120)">GREEN</button>
  <button class="button blue3" type="button" on:click="setColor(240)">BLUE</button>
  <button class="button" type="button" on:click="setColor(0, 0)">WHITE</button>
</div>

<div class="form-group">
  <MinnaSwitch bind:value="on" on:change="toggle()" />
</div>

<div class="form-group mt4">
  <datalist id="tickmarks">
    <option value="1" label="1%">
    <option value="10">
    <option value="20">
    <option value="30">
    <option value="40">
    <option value="50" label="50%">
    <option value="60">
    <option value="70">
    <option value="80">
    <option value="90">
    <option value="100" label="100%">
  </datalist>

  <label class="label" for="brightness">Brightness</label>
  <input bind:value="brightness" class="range" type="range" list="tickmarks" on:change="setBrightness()">
  <MinnaInputNumber bind:value="brightness" id="brightness" on:change="setBrightness()" />
</div>

<div class="form-group mt4">
  <label class="label" for="colour">Colour</label>
  <input bind:value="colour" class="color" type="color" id="colour" on:change="setColourRGB()">
  {colour}
</div>

<div>
  location: {location}
</div>

<script>
  import MinnaSwitch from '@minna-ui/switch';
  import MinnaInputNumber from '../components/MinnaInputNumber.html';

  /* eslint-disable id-length, no-nested-ternary */
  function hexToRgb(color) {
    let hex = color[0] === '#' ? color.slice(1) : color;
    let c;

    // expand the short hex by doubling each character, fc0 -> ffcc00
    if (hex.length !== 6) {
      hex = ((() => {
        const result = [];
        for (c of Array.from(hex)) { // eslint-disable-line no-restricted-syntax
          result.push(`${c}${c}`);
        }
        return result;
      })()).join('');
    }
    const colorStr = hex.match(/#?(.{2})(.{2})(.{2})/).slice(1);
    const rgb = colorStr.map(col => parseInt(col, 16));
    rgb.push(1);
    return rgb;
  }

  function rgbToHsl(rgb) {
    const r = rgb[0] / 255;
    const g = rgb[1] / 255;
    const b = rgb[2] / 255;

    const max = Math.max(r, g, b);
    const min = Math.min(r, g, b);
    const diff = max - min;
    const add = max + min;

    const hue = min === max
      ? 0
      : r === max
        ? (((60 * (g - b)) / diff) + 360) % 360
        : g === max
          ? ((60 * (b - r)) / diff) + 120
          : ((60 * (r - g)) / diff) + 240;

    const lum = 0.5 * add;

    const sat = lum === 0
      ? 0
      : lum === 1
        ? 1
        : lum <= 0.5
          ? diff / add
          : diff / (2 - add);

    const h = Math.round(hue);
    const s = Math.round(sat * 100);
    const l = Math.round(lum * 100);
    const a = rgb[3] || 1;

    return [h, s, l, a];
  }
  /* eslint-enable */

  export default {
    components: {
      MinnaSwitch,
      MinnaInputNumber,
    },
    data: () => ({
      brightness: 1,
      colour: '#ff0000',
      location: '',
      on: false,
    }),
    oncreate() {
      this.getDeviceInfo();
    },
    methods: {
      async getDeviceInfo() {
        const res = await fetch('/api/device/info');
        if (!res.ok) throw new Error(res.statusText);
        const info = await res.json();
        console.debug('[DEVICE INFO]', info);
        this.set({
          brightness: info.bright,
          // colour: info.rgb,
          location: info.location,
          on: info.status === 'on',
        });
      },

      async toggle() {
        const res = await fetch('/api/command?action=toggle');
        if (!res.ok) throw new Error(res.statusText);
      },

      async setBrightness() {
        const { brightness } = this.get();
        const res = await fetch(`/api/command?action=brightness&value=${brightness}`);
        if (!res.ok) throw new Error(res.statusText);
      },

      async setColourRGB() {
        const { colour } = this.get();
        const rgb = hexToRgb(colour);
        const [hue, saturation] = rgbToHsl(rgb);
        this.setColor(hue, saturation);
      },

      async setColor(hue, saturation = 100) {
        const res = await fetch(`/api/command?action=color&hue=${hue}&saturation=${saturation}`);
        if (!res.ok) throw new Error(res.statusText);
      },
    },
  };
</script>

<style type="text/postcss">
  .range {
    width: 16rem;
  }

  .color {
    width: 8rem;
  }
</style>
